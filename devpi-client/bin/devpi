#!/bin/sh

version="0.1.1"

# A script for all devpi commands to be sent to a docker container.

# variables to pass into/set-up the devpi-client container.
# adjust accordingly
DEVPI_USER="root"
DEVPI_HOST="default.docker"
DEVPI_PORT="3141"
DEVPI_INDEX="root/public"
SITE_PACKAGES=
SCHEME="http"
URL="${SCHEME}://${DEVPI_HOST}:${DEVPI_PORT}"

# read docker machine name from environment or set to default machine.
: ${DOCKER_MACHINE_NAME="default"}


if [[ "$(uname)" == "Darwin" ]]; then
    # check that docker-machine is running in OS X
    # change name if your docker machine name is not default
    # ex. $(docker-machine status docker)

    if ! [[ "$(docker-machine status $DOCKER_MACHINE_NAME)" == "Running" ]]; then
        docker-machine start "$DOCKER_MACHINE_NAME"
    fi

    # connect to the docker daemon on OS X
    # change name if your docker-machine name is not default
    # ex. $(docker-machine env docker)
    eval $(docker-machine env "$DOCKER_MACHINE_NAME")
fi


if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    # show help pages and exit
    docker run mhoush/devpi-client "$@"
    exit 0
fi

# check for virtual env in the environment.
# and mount the site-packages directory if so
if ! [[ "${VIRTUAL_ENV}" == "" ]]; then
    # find the site-packages for the virtualenv
    # only checks for python versions 3.5 and 2.7
    if [[ -d "${VIRTUAL_ENV}/lib/python3.5/site-packages" ]]; then
        SITE_PACKAGES="${VIRTUAL_ENV}/lib/python3.5/site-packages"
    elif [[ -d "${VIRTUAL_ENV}/lib/python2.7/site-packages" ]]; then
        SITE_PACKAGES="${VIRTUAL_ENV}/lib/python2.7/site-packages"
    fi
fi

machine_url(){
    # get's the ip address of the machine.  May not be needed if not running OS X.
    local host="$(docker-machine url $DOCKER_MACHINE_NAME)"
    host=${host##tcp://} # remove tcp:// from front host string
    host=${host%:2376} # remove :2376 from tail of host string
    echo $host
}

if [[ "$SITE_PACKAGES" == "" ]]; then
    # start a container without site-packages mounted
    # the --add-host option may not be necessary depending on your setup, but required
    # for mine running on OS X
    docker run -it --rm \
        --add-host "${DEVPI_HOST}":"$(machine_url)" \
        -v "${PWD}":/mnt \
        -v "${HOME}/.certs":/certs \
        -v "${HOME}/.pip/":/root/.pip \
        -e DEVPI_USER="${DEVPI_USER}" \
        -e DEVPI_URL="${URL}" \
        -e DEVPI_INDEX="${DEVPI_INDEX}" \
        mhoush/devpi-client "$@"
else
    # start a container with site-packages mounted
    # the --add-host option may not be necessary depending on your setup, but required
    # for mine running on OS X
    docker run  -it --rm \
        --add-host "${DEVPI_HOST}":"$(machine_url)" \
        -v "${PWD}":/mnt \
        -v "$SITE_PACKAGES":/site-packages \
        -v "${HOME}/.certs":/certs \
        -v "${HOME}/.pip":/root/.pip \
        -e DEVPI_USER="${DEVPI_USER}" \
        -e DEVPI_URL="${URL}" \
        -e DEVPI_INDEX="${DEVPI_INDEX}" \
        mhoush/devpi-client "$@"
fi
